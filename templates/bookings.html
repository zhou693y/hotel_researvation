<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è®¢ç®¡ç† - é…’åº—å®¢æˆ¿é¢„è®¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ¨ é…’åº—å®¢æˆ¿é¢„è®¢ç³»ç»Ÿ</h1>
            <nav>
                <a href="/">é¦–é¡µ</a>
                <a href="/rooms">å®¢æˆ¿ç®¡ç†</a>
                <a href="/customers">å®¢æˆ·ç®¡ç†</a>
                <a href="/bookings" class="active">é¢„è®¢ç®¡ç†</a>
            </nav>
        </header>

        <main>
            <div class="page-header">
                <h2>é¢„è®¢ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showAddModal()">+ æ–°å»ºé¢„è®¢</button>
            </div>

            <div class="table-container">
                <table id="bookingsTable">
                    <thead>
                        <tr>
                            <th>é¢„è®¢å·</th>
                            <th>å®¢æˆ·å§“å</th>
                            <th>æˆ¿é—´å·</th>
                            <th>å…¥ä½æ—¥æœŸ</th>
                            <th>é€€æˆ¿æ—¥æœŸ</th>
                            <th>æ€»ä»·</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody">
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- æ–°å»ºé¢„è®¢æ¨¡æ€æ¡† -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>æ–°å»ºé¢„è®¢</h3>
            <form id="bookingForm">
                <div class="form-group">
                    <label>å®¢æˆ·:</label>
                    <select id="customerId" required>
                        <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å®¢æˆ¿:</label>
                    <select id="roomId" required onchange="updatePrice()">
                        <option value="">è¯·é€‰æ‹©å®¢æˆ¿</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å…¥ä½æ—¥æœŸ:</label>
                    <input type="date" id="checkInDate" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label>é€€æˆ¿æ—¥æœŸ:</label>
                    <input type="date" id="checkOutDate" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label>æ€»ä»·:</label>
                    <input type="number" id="totalPrice" step="0.01" readonly>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨:</label>
                    <textarea id="remarks" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é€€æˆ¿æ¨¡æ€æ¡† -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCheckoutModal()">&times;</span>
            <h3>åŠç†é€€æˆ¿</h3>
            <form id="checkoutForm">
                <input type="hidden" id="checkoutBookingId">
                <div class="form-group">
                    <label>å®é™…é‡‘é¢:</label>
                    <input type="number" id="actualAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>æ”¯ä»˜æ–¹å¼:</label>
                    <select id="paymentMethod" required>
                        <option value="ç°é‡‘">ç°é‡‘</option>
                        <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
                        <option value="å¾®ä¿¡">å¾®ä¿¡</option>
                        <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ç¡®è®¤é€€æˆ¿</button>
                    <button type="button" class="btn" onclick="closeCheckoutModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let roomPrices = {};

        function loadBookings() {
            fetch('/api/bookings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('bookingsTableBody');
                        tbody.innerHTML = '';
                        data.data.forEach(booking => {
                            const tr = document.createElement('tr');
                            let actions = '';

                            if (booking.status === 'å·²é¢„è®¢') {
                                actions = `
                                    <button class="btn-small" onclick="checkIn(${booking.booking_id})">å…¥ä½</button>
                                    <button class="btn-small btn-danger" onclick="cancelBooking(${booking.booking_id})">å–æ¶ˆ</button>
                                `;
                            } else if (booking.status === 'å·²å…¥ä½') {
                                actions = `<button class="btn-small" onclick="showCheckoutModal(${booking.booking_id}, ${booking.total_price})">é€€æˆ¿</button>`;
                            }

                            tr.innerHTML = `
                                <td>${booking.booking_id}</td>
                                <td>${booking.customer_name}</td>
                                <td>${booking.room_number}</td>
                                <td>${booking.check_in_date}</td>
                                <td>${booking.check_out_date}</td>
                                <td>Â¥${booking.total_price}</td>
                                <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
                                <td>${actions}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                });
        }

        function showAddModal() {
            document.getElementById('bookingForm').reset();
            loadCustomers();
            loadAvailableRooms();
            document.getElementById('bookingModal').style.display = 'block';
        }

        function loadCustomers() {
            fetch('/api/all-customers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('customerId');
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>';
                        data.data.forEach(customer => {
                            select.innerHTML += `<option value="${customer.customer_id}">${customer.name} - ${customer.phone}</option>`;
                        });
                    }
                });
        }

        function loadAvailableRooms() {
            fetch('/api/available-rooms')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('roomId');
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ¿</option>';
                        roomPrices = {};
                        data.data.forEach(room => {
                            select.innerHTML += `<option value="${room.room_id}">${room.room_number} - ${room.room_type} (Â¥${room.price}/æ™š)</option>`;
                            roomPrices[room.room_id] = room.price;
                        });
                    }
                });
        }

        function updatePrice() {
            calculateTotal();
        }

        function calculateTotal() {
            const roomId = document.getElementById('roomId').value;
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;

            if (roomId && checkIn && checkOut) {
                const price = roomPrices[roomId];
                const days = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
                if (days > 0) {
                    document.getElementById('totalPrice').value = (price * days).toFixed(2);
                }
            }
        }

        function checkIn(bookingId) {
            if (confirm('ç¡®è®¤åŠç†å…¥ä½ï¼Ÿ')) {
                fetch(`/api/bookings/${bookingId}/checkin`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) loadBookings();
                    });
            }
        }

        function showCheckoutModal(bookingId, totalPrice) {
            document.getElementById('checkoutBookingId').value = bookingId;
            document.getElementById('actualAmount').value = totalPrice;
            document.getElementById('checkoutModal').style.display = 'block';
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        function cancelBooking(bookingId) {
            if (confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªé¢„è®¢å—ï¼Ÿ')) {
                fetch(`/api/bookings/${bookingId}/cancel`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) loadBookings();
                    });
            }
        }

        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        document.getElementById('bookingForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const bookingData = {
                customer_id: parseInt(document.getElementById('customerId').value),
                room_id: parseInt(document.getElementById('roomId').value),
                check_in_date: document.getElementById('checkInDate').value,
                check_out_date: document.getElementById('checkOutDate').value,
                total_price: parseFloat(document.getElementById('totalPrice').value),
                remarks: document.getElementById('remarks').value
            };

            fetch('/api/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        closeModal();
                        loadBookings();
                    }
                });
        });

        document.getElementById('checkoutForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const bookingId = document.getElementById('checkoutBookingId').value;
            const checkoutData = {
                actual_amount: parseFloat(document.getElementById('actualAmount').value),
                payment_method: document.getElementById('paymentMethod').value
            };

            fetch(`/api/bookings/${bookingId}/checkout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(checkoutData)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        closeCheckoutModal();
                        loadBookings();
                    }
                });
        });

        loadBookings();
    </script>
</body>

</html>